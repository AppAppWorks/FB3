<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>
<head>
	<title>Уровни поддержки FB3</title>
</head>

<body>
<p>Данный документ описывает требования к програмамам-читалкам и программам-конвертерам (далее программам), работающим
с fb3. Требования являются частью стандарта и позволяют предсказуемым образом описывать степень
совместимости приложений с форматом и глубину его поддержки.</p>
<p>Цель данных «требований» не в том, чтобы ограничить свободу разработчика. Это некие рекомендации по приоритетам и,
главное, способ упростить коммуникацию между разработчиками, читателями, библиотеками и редакторами. Например, в библиотеке
может стоять метка «данная книга требует читалки уровня 20» и читатель сможет оценить, стоит ли ему в
принципе скачивать данный документ, или на его читалке/устройстве он все равно ничего отобразить не сможет.
Редактор, соответственно, будет стараться заверстать текст на fb3 с максимальным уровнем совместимости, либо, если
это невозможно и редактор видит, что документ в упрощенном виде теряет смысл, поставить особую отметку. И т.д.</p>

<p>В дальнейшем возможно некое тестирование и присвоение уровня совместимости в
соответствии с данным описанием, пока же же авторы ПО могут сами ссылаться на
данный документ и указывать степень поддержки fb3.</p>

<h1>0. «Только текст»</h1>
<p>Файл fb3 представляет собой пакет <a href="http://www.ecma-international.org/publications/standards/Ecma-376.htm">
OPC (ECMA-376 Part 2)</a>, и всем разработчикам рекомендуется ознакомиться с соответствующей документацией.</p>
<p>Однако, вкратце мы остановимся на сруктуре OPC. По сути OPC-пакет это обычный zip-архив. В архиве, поименованные
	особым образом, размещается несколько файлов с XML либо с графикой. Для чтения fb3 достаточно базового
	понимания работы с OPC-пакетом:</p>

<ol>
	<li>Вы открываете <code>/_rels/.rels</code>, это XML-файл с фиксированным именем, описывающий где что лежит
		в данном пакете. Остальные файлы внутри пакета не имеют стандартных имен, имена всех файлов для работы
		следует извлекать из этого файла или из файлов, на которые ссылается этот файл.</li>
	<li>Вы находите адрес файла мета-информации о книге (URI http://www.fictionbook.org/FictionBook3/relationships/Book,
		узел <code>/Relationships[@Type = 'http://www.fictionbook.org/FictionBook3/relationships/Book']/@Target</code>).
		
		Допустим, атрибут @Target содержит <code>fb3/description.xml</code>. В этом файле содержится вся описательная
		информация о книге - название, автор, etc. Таких файлов может быть несколько, если файл fb3 это подшивка,
		но не менее одного. Для уровня совместимости 0 допустимо использовать только первый мета-файл и игнорировать
		последующие, то есть можно читать только первую книгу из подшивки, но при этом следует выдать
		сообщение пользователю о том, что часть содержимого не отображена.</li>
	<li>Вы находите соответствующий данному файлу мета-информации файл <code>.rels</code>, это опять же XML, похожий на
		корневой <code>.rels</code>, описывающий где что лежит. Если файл с мета-информацией размещен в
		<code>/fb3/description.xml</code>, вам понадобится файл <code>/fb3/_rels/description.xml.rels</code>.</li>
	<li>Вы находите в этом <code>.rels</code> адрес связанного с данной метаинформацией файла с текстом (узел
		<code>/Relationships[@Type = 'http://www.fictionbook.org/FictionBook3/relationships/body']/@Target</code>).
		в этом файле размещается текст книги. Для подшивки, соответственно, таких файлов так же может быть много,
		ссылки на каждый из которых размещаются в соответствующих их мета-файлам <code>.rels</code>-файлах.
	</li>
</ol>
<p>Не следует полагаться на то, что файл с мета-информацией всегда будет размещен в fb3/description.xml или
	где-либо еще по фиксированному адресу, это <strong>ошибка</strong>.</p>

<p>Обработка и отображение мета-информации на уровне 0 не требуется, по сути файл мета-информации
	можно игнорировать и переходить сразу к тексту.</p>

<p>Текст книги на уровне 0 допустимо рассматривать как plain-text. Все содержимое fb3-body очищается от тегов,
узлы уровня block-level (список позже) обрабатываться как абзацы, с переносом строк, остальной текст нормализуется.
Помимо этого следует заменять картинки на содержимое арибута alt.</p>

<p>Чтение на нулевом уровне имеет смысл на ранных стадиях поддержки формата и на устройствах с
	экстремально бедными ресурсами, рекомендуемый минимальный уровень поддержки формата следующий, 10-й.</p>

<h1>10. «На уровне fb2»</h1>
<p>Каждый следующий уровень совместимости расширяет предыдущий, поэтому все, что качается работы с OPC
	на уровне 0 верно и для уровня 10. Помимо этого, поскольку уровень 10 предполагает работу с картинками,
	следует учитывать требования OPC к ссылкам внутри пакета.</p>
<ol>
	<li>При работе с картинками и другими внешними для файла с текстом книги объектами имейте в виду, что
		в тексте ссылка идет не на конкретный объект в пакете (файл в архиве), а на его ID в .rels файле. Для файла
		с телом, размещенным в <code>/fb3/body.xml</code> вам потребуется прочитать <code>/fb3/_rels/body.xml.rels</code>
		и узнать там, как соотносится ID, на который ссылается документ, с реальным файловым содержимым пакета.
		При этом может быть ситуация, когда в документе, ссылающемся на рисунок «123.jpg» в действительности следует отобразить
		файл «567.png», которым был заменен исходный рисунок путем изменения в файле связей.</li>
	<li>Помимо косвенных ссылок на файлы в пакете следует учитывать и неприменимость расширения
		в качестве определителя типа файла. Ожидания отночительно содержимого каждого конкретного
		файла должны выбираться не непосредственно по его расширению, а в соответствии с указаниями
		из <code>[Content_Types].xml</code>. Это файл с фиксированным именем, размещается в корне архива.
		о есть, если в пакете есть файл <code>123.xml</code>, и <code>[Content_Types].xml</code> описывает
		его содержимое как image/jpeg, программа должна считать, что перед ней рисунок в формате jpeg.</li>
</ol>
<p>За более подробной информацией об использовании связей и типизации файлов в OPC-пакетах обращайтесь к документации
<a href="http://www.ecma-international.org/publications/standards/Ecma-376.htm">ECMA-376 Part 2</a>,
	главы «9.3.2 Relationship Markup» и «9.1.2 Content Types».</p>
<p>Помимо поддержки косвенной адресации и явной типизации файлов программа, соответствующая уровню 10,
	должна отображать текс со следующими элементами:</p>
<ul>
	<li>Заголовки для всего тела и для секций</li>
	<li>Block-level элементы subtitle, code, poem, blockquote, br, subscription</li>
	<li>Форматирование текста: strong, em.</li>
	<li>Сноски и ссылки: note, a. Сноски можно отображать в виде простых ссылок.</li>
	<li>Точечные рисунки в форматах: jpg, png, gif хотя бы в оригинальном разрешении.</li>
	<li></li>
</ul>
<p>Для основного текста обязательнго должно поддерживаться выравнивание по ширине и переносы.</p>
<p>Данный уровень поддержки легко достижим для любой существующей читалки, на каком бы формате она не была основана.
	Для поддержки формата необходима, в основном, реализация корректной работы с OPC-пакетом, остальные
	функции можно считать стандартными для всего подобного ПО.</p>

<h1>20. «SVG и таблицы»</h1>
<p>На данном уровне совместимости требуется реализовать ряд дополнительных элементов форматирования,
	таких как таблицы, списки, зачеркнутый текст и т.д. Так же требуется поддержка векторного формата рисунков SVG
	и учет рекомендаций по размерам при отображении рисунков.</p>
<p>Требуется отображение всех возможных для StyleType inline-элементов, а так же block-level элементов table, ol, ul</p>

<h1>100. «Полная совместимость»</h1>
<p>В дополнение к предыдущему уровню должна быть поддержка block-level элементов div со всеми атрибутами
	(размер, обтекание, маркеры и прочее).</p>
</body>
</html>
